"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard"),_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_objectSpread3=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_react=_interopRequireWildcard(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_isEqual=_interopRequireDefault(require("lodash/isEqual")),_hoistNonReactStatics=_interopRequireDefault(require("hoist-non-react-statics")),_reactReduxFirebase=require("react-redux-firebase"),_query=require("react-redux-firebase/lib/actions/query"),_utils=require("react-redux-firebase/lib/utils"),_getEventsFromInput=function(a){var b=[];return a?(Object.keys(a).forEach(function(c){var d=a[c],e=d.path,f=d.listeners;f.forEach(function(a){b.push({path:e,queryParams:a})})}),(0,_utils.getEventsFromInput)(b)):b},getDisplayName=function(a){return a.displayName||a.name||("string"==typeof a?a:"Component")},firebaseConnect=function(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{};return function(b){var c=function(c){function d(b,c){var e;(0,_classCallCheck2.default)(this,d);var f=c.store.firebase;e=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(d).call(this)),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)((0,_assertThisInitialized2.default)(e)),"firebaseEvents",[]),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)((0,_assertThisInitialized2.default)(e)),"firebase",null),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)((0,_assertThisInitialized2.default)(e)),"prevData",null),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)((0,_assertThisInitialized2.default)(e)),"getUpdatedEvents",function(a){var b=_getEventsFromInput(a),c=e.firebaseEvents,d=[],f=c;return b.forEach(function(a){var b=a.queryId,e=c.some(function(a){var c=a.queryId;return c===b});e?f=f.filter(function(a){var c=a.queryId;return c!==b}):d.push(a)}),{addedEvents:d,removedEvents:f}}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)((0,_assertThisInitialized2.default)(e)),"getStateProps",function(a){var b=e.context.store.getState,c=b(),d={},f=a||e.prevData;return Object.keys(f).forEach(function(a){var b=f[a],g=b.path,h=b.defaultValue,i=(0,_reactReduxFirebase.dataToJS)(c.firebase,g),j="isLoaded".concat(a[0].toUpperCase()).concat(a.substr(1)),k=d[j]||(0,_reactReduxFirebase.isLoaded)(i),l=e.state&&e.state[g]&&e.state[g].value,m="object"===(0,_typeof2.default)(l)&&"object"===(0,_typeof2.default)(i);h&&!k&&(i="function"==typeof h?h(c):[c].concat(h.split(".")).reduce(function(c,a){return c[a]}),k=!!i),d.propsToPaths=(0,_objectSpread3.default)({},d.propsToPaths,(0,_defineProperty2.default)({},a,g)),d[g]={isLoaded:k,value:m?(0,_objectSpread3.default)({},l,i):i}}),d});var g=(0,_utils.createCallable)(a),h=g(b,f);return e.prevData=h,e.context=c,e.state=e.getStateProps(h),e}return(0,_inherits2.default)(d,c),(0,_createClass2.default)(d,[{key:"componentWillMount",value:function(){var a=this.context.store.firebase;if(a){var b=a.ref,c=a.helpers,d=a.storage,e=a.database,f=a.auth;this.firebase=(0,_objectSpread3.default)({ref:b,storage:d,database:e,auth:f},c),this.firebaseEvents=_getEventsFromInput(this.prevData)}}},{key:"componentDidMount",value:function(){var a=this.context.store,b=a.firebase,c=a.dispatch;b&&(0,_query.watchEvents)(b,c,this.firebaseEvents)}},{key:"componentWillUnmount",value:function(){var a=this.context.store,b=a.firebase,c=a.dispatch;(0,_query.unWatchEvents)(b,c,this.firebaseEvents)}},{key:"componentWillReceiveProps",value:function(b){var c=this.context.store,d=c.firebase,e=c.dispatch,f=(0,_utils.createCallable)(a),g=f(b,d),h=this.getUpdatedEvents(g),i=h.addedEvents,j=h.removedEvents,k=this.getStateProps(g);(i.length||j.length)&&(this.prevData=g,(0,_query.unWatchEvents)(d,e,this.firebaseEvents),this.firebaseEvents=_getEventsFromInput(g),(0,_query.watchEvents)(d,e,this.firebaseEvents)),(0,_isEqual.default)(k,this.state)||this.setState(k)}},{key:"render",value:function(){var a=this,c=this.state.propsToPaths,d={};return Object.keys(c).forEach(function(b){var e=a.state,f=c[b],g=a.prevData[b]&&a.prevData[b].modifyResult,h="isLoaded".concat(b[0].toUpperCase()).concat(b.substr(1));d[h]=e[f].isLoaded,d[b]="function"==typeof g?g(e[f].value):e[f].value}),_react.default.createElement(b,(0,_extends2.default)({},this.props,d))}}]),d}(_react.Component);return(0,_defineProperty2.default)(c,"contextTypes",{store:_propTypes.default.object.isRequired}),(0,_defineProperty2.default)(c,"displayName","FirebaseConnect(".concat(getDisplayName(b),")")),(0,_defineProperty2.default)(c,"wrappedComponent",b),(0,_hoistNonReactStatics.default)(c,b)}},_default=firebaseConnect;exports.default=_default;
"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard"),_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"reactReduxFirebase",{enumerable:!0,get:function(){return _reactReduxFirebase.reactReduxFirebase}}),Object.defineProperty(exports,"firebaseStateReducer",{enumerable:!0,get:function(){return _reactReduxFirebase.firebaseStateReducer}}),Object.defineProperty(exports,"getFirebase",{enumerable:!0,get:function(){return _reactReduxFirebase.getFirebase}}),exports.firebaseConnect=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_objectSpread3=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_react=_interopRequireWildcard(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_hoistNonReactStatics=_interopRequireDefault(require("hoist-non-react-statics")),_reactReduxFirebase=require("react-redux-firebase"),_query=require("react-redux-firebase/lib/actions/query"),_utils=require("react-redux-firebase/lib/utils"),_getEventsFromInput=function(a){var b=[];return a?(Object.keys(a).forEach(function(c){var d=a[c],e=d.path,f=d.listeners;f.forEach(function(a){b.push({path:e,queryParams:a})})}),(0,_utils.getEventsFromInput)(b)):b},getDisplayName=function(a){return a.displayName||a.name||("string"==typeof a?a:"Component")},firebaseConnect=function(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},b=1<arguments.length?arguments[1]:void 0;return function(c){var d={},e=function(b){function e(b,c){var f;(0,_classCallCheck2.default)(this,e);var g=c.store.firebase;f=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(e).call(this)),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)((0,_assertThisInitialized2.default)(f)),"firebaseEvents",[]),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)((0,_assertThisInitialized2.default)(f)),"firebase",null),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)((0,_assertThisInitialized2.default)(f)),"prevData",null),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)((0,_assertThisInitialized2.default)(f)),"getUpdatedEvents",function(a){var b=_getEventsFromInput(a),c=f.firebaseEvents,d=[],e=c;return b.forEach(function(a){var b=a.queryId,f=c.some(function(a){var c=a.queryId;return c===b});f?e=e.filter(function(a){var c=a.queryId;return c!==b}):d.push(a)}),{addedEvents:d,removedEvents:e}}),(0,_defineProperty2.default)((0,_assertThisInitialized2.default)((0,_assertThisInitialized2.default)(f)),"getStateProps",function(a){var b=f.context.store.getState,c=b(),e={},g=a||f.prevData;return Object.keys(g).forEach(function(a){var b=g[a],h=b.path,i=b.defaultValue,j=(0,_reactReduxFirebase.dataToJS)(c.firebase,h);d[a]=function(a){return(0,_reactReduxFirebase.dataToJS)(a.firebase,h)};var k="isLoaded".concat(a[0].toUpperCase()).concat(a.substr(1)),l=e[k]||(0,_reactReduxFirebase.isLoaded)(j),m=f.state&&f.state[h]&&f.state[h].value,n="object"===(0,_typeof2.default)(m)&&"object"===(0,_typeof2.default)(j);i&&!l&&(j="function"==typeof i?i(c):"string"==typeof i&&/\./.test(i)?[c].concat(i.split(".")).reduce(function(c,a){return c[a]}):i,l=!!j),e.propsToPaths=(0,_objectSpread3.default)({},e.propsToPaths,(0,_defineProperty2.default)({},a,h)),e[h]={isLoaded:l,value:n?(0,_objectSpread3.default)({},m,j):j}}),e});var h=(0,_utils.createCallable)(a),i=h(b,g);return f.prevData=i,f.context=c,f.state=f.getStateProps(i),f}return(0,_inherits2.default)(e,b),(0,_createClass2.default)(e,[{key:"componentWillMount",value:function(){var a=this.context.store.firebase;if(a){var b=a.ref,c=a.helpers,d=a.storage,e=a.database,f=a.auth;this.firebase=(0,_objectSpread3.default)({ref:b,storage:d,database:e,auth:f},c),this.firebaseEvents=_getEventsFromInput(this.prevData)}}},{key:"componentDidMount",value:function(){var a=this.context.store,b=a.firebase,c=a.dispatch;b&&(0,_query.watchEvents)(b,c,this.firebaseEvents)}},{key:"componentWillUnmount",value:function(){var a=this.context.store,b=a.firebase,c=a.dispatch;(0,_query.unWatchEvents)(b,c,this.firebaseEvents)}},{key:"componentWillReceiveProps",value:function(b){var c=this.context.store,d=c.firebase,e=c.dispatch,f=(0,_utils.createCallable)(a),g=f(b,d),h=this.getUpdatedEvents(g),i=h.addedEvents,j=h.removedEvents,k=this.getStateProps(g);(i.length||j.length)&&(this.prevData=g,(0,_query.unWatchEvents)(d,e,this.firebaseEvents),this.firebaseEvents=_getEventsFromInput(g),(0,_query.watchEvents)(d,e,this.firebaseEvents)),this.setState(k)}},{key:"render",value:function(){var a=this,b=this.state.propsToPaths,d={};return Object.keys(b).forEach(function(c){var e=a.state,f=b[c],g=a.prevData[c]&&a.prevData[c].modifyResult,h="isLoaded".concat(c[0].toUpperCase()).concat(c.substr(1));d[h]=e[f].isLoaded,d[c]="function"==typeof g?g(e[f].value):e[f].value}),_react.default.createElement(c,(0,_extends2.default)({},this.props,d))}}]),e}(_react.PureComponent);(0,_defineProperty2.default)(e,"contextTypes",{store:_propTypes.default.object.isRequired}),(0,_defineProperty2.default)(e,"displayName","FirebaseConnect(".concat(getDisplayName(c),")")),(0,_defineProperty2.default)(e,"wrappedComponent",c);var f=(0,_hoistNonReactStatics.default)(e,c);return b?b(d)(f):f}};exports.firebaseConnect=firebaseConnect;